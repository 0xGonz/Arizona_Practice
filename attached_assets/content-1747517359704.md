# Employee+business Analysis Feature Prd

You’re viewing user-generated content that may be unverified or unsafe.

[Report](https://openai.com/form/report-content/)

ChatGPTEdit with ChatGPTEdit

# Employee & Business Analysis Module – Product Requirements

## 1 · Purpose

Add two analytical pages – **Employee Analysis** and **Business Line Analysis** – that tap into the existing _Monthly Analytics_ dataset to visualise revenue, expenses and net income overall **and** drill‑down profitability for individual employees or business lines ("E" vs "O" uploads). Both pages share a near‑identical UI skeleton so they can re‑use components and queries.

## 2 · Success Metrics

| KPI | Target |
| --- | --- |
| Page load < 1.5 s (95‑pctl) | ✔︎ |
| API response < 400 ms for filter queries | ✔︎ |
| Interactive filter (select employee/line) → chart refresh < 300 ms | ✔︎ |
| User can answer “Which doctor generated the highest net in March?” inside 10 s | ✔︎ |

## 3 · Data Model Source

All data is derived **server‑side** from existing tables:

- `monthly_financial_data` – totals per month.

- `doctor_performance` – per‑employee monthly figures.

- `department_performance` – per‑business (“O”) monthly figures.


> No new tables required – we expose **parametrised views** via new endpoints.

## 4 · API Endpoints

|     |     |     |     |
| --- | --- | --- | --- |
| Method | Path | Query Params | Returns |
| GET | /api/analytics/employee/summary | `from`, `to` | \[{ month, revenue, expense, net }\] |
| GET | /api/analytics/employee/detail | `employeeId`, `from`, `to` | \[{ month, revenue, expense, net, marginPct }\] |
| GET | /api/analytics/business/summary | `from`, `to` | same shape as above |
| GET | /api/analytics/business/detail | `businessId`, … | idem |

Implementation: `financial-data-manager.ts` gains helpers `getEmployeeSummary`, `getEmployeeDetail`, `getBusinessSummary`, `getBusinessDetail`. Use **parameterised SQL** so row‑level filters require only an index on `(clinic_id, month)`.

## 5 · State & Caching

- React‑Query keys:

  - `['emp-summary', from, to]`

  - `['emp-detail', id, from, to]`

  - `['biz-summary', …]`, `['biz-detail', …]`
- 12 h _staleTime_; filters invalidate corresponding keys.

- Zustand slice `analysisFilters` to hold: `range`, `selectedEmployee`, `selectedBusiness`.


## 6 · UI/UX Layout

┌────────────────────────── Employee Analysis ──────────────────────────┐

│ ① Filters │

│ • Period ▼ \[ Full‑Year \| Monthly \] │

│ ↳ if \*Monthly\* → Month‑picker (MMM‑YYYY) │

│ • Entity ▼ \[ All Employees \] (combo populated at runtime) │

│ ───────────────────────────────────────────────────────────────────── │

│ ② KPI Cards Total Revenue \| Total Expense \| Net Income │

│ ───────────────────────────────────────────────────────────────────── │

│ ③ Revenue vs Expense vs Net (grouped‑bar by Month or by Quarter) │

│ ───────────────────────────────────────────────────────────────────── │

│ ④ Profitability │

│ • \*All Employees\* → horizontal bar of Net by employee │

│ • \*One Employee\* → line‑chart of Margin % trend │

│ ───────────────────────────────────────────────────────────────────── │

│ ⑤ Data Table (paginated, sticky header) │

│ \| Month \| Total Revenue \| Total Expense \| Net Income \| Margin % \| │

└───────────────────────────────────────────────────────────────────────┘

_Business Analysis_ swaps the **Entity** combo for _Business Line_ while preserving the same period controls.

### Column Headers

The data table always mirrors the exact column names found on the consolidated sheets:

- **Total Revenue** (line 17)

- **Total Operating Expenses** (line 183)

- **Net Income (Loss)** (line 206)
Any additional sheet columns (e.g., Ancillary Revenue, COGS) can be toggled on via a column‑chooser in future iterations.


## 7 · Components (re‑use first!)

|     |     |     |
| --- | --- | --- |
| Component | Description |
| `<FiltersBar>` | Holds three controls: _(a)_**PeriodDropdown** (full‑year vs monthly), _(b)_**MonthPicker** (shown only when "Monthly"), _(c)_**SelectDropdown** (Employees or Business lines). Updates Zustand `analysisFilters`. |
| `<PeriodDropdown>` | Simple shadcn `<Select>` with two options. Triggers `setPeriod()`; defaults to full‑year (rolling 12). |
| `<MonthPicker>` | Radix `<Popover>` calendar, disabled when period=full‑year. |
| `<KpiCard>` | Existing dashboard KPI component. |
| `<MonthlyBarChart>` | Grouped or stacked bar driven by dataset granularity. |
| `<ProfitabilityChart>` | Horizontal bar (multi) or line (single). |
| `<AnalysisTable>` | Tailwind table with sticky column headers reflecting sheet names. | · Components (re‑use first!) |
| Component | Description |
| \-\-\--------- | \-\-\----------- |
| `<FiltersBar>` | Date range picker (shadcn `<CalendarRangePicker>`), SelectDropdown (react‑select) populated from `/api/analytics/employee/list`. Calls `analysisFilters.set()` in Zustand. |
| `<KpiCard>` (existing) | Already in Dashboard – re‑use. |
| `<MonthlyBarChart>` | Wrapper around `react-chartjs-2` Bar. Props: `data`, `labels`. Accept `groupMode = "stack" | "group"`. |
| `<ProfitabilityChart>` | When _All_ → HorizontalBar (total net by entity); when one selected → Line chart of `marginPct`. |
| `<AnalysisTable>` | Plain Tailwind table, export CSV. |

## 8 · Filtering Logic

1. On page mount, call summary endpoint with default range (rolling 12 months) & `entityId = null`.

2. When user picks an entity, parallel‑fetch **detail** endpoint; charts/tables swap to detail data.

3. Removing selection reverts to summary dataset.


## 9 · Technical Tasks

### Backend

### Frontend

### DevOps

## 10 · Acceptance Criteria

1. Selecting an employee instantly updates both charts & table.

2. Selecting a business line does the same on Business page.

3. Export CSV respects current filters.

4. No console errors nor React‑Query retries in Lighthouse run.

5. Back‑end queries never scan full tables (checked via `EXPLAIN`).


## 11 · Future Extensions

- Cohort comparison mode (multi‑select entities, unique colors).

- Overlay budget targets once budget CSV integrated.

- Push chart images into quarterly board decks via /export/png endpoint.


* * *

**Owner:** Brett G. ⋅ **Tech lead:** (assign) ⋅ **Design:** (optional) ⋅ **ETA:** 1 week MVP

## 12 · Data Wiring Reference Implementation

Below is a concrete, copy‑paste‑ready blueprint that mirrors the **Dashboard** data flow (Postgres → API → React Query → Zustand → Components) for the two new tabs.

### 12.1 Back‑end (Express + Drizzle)

// server/analytics-routes.ts

import { Router } from 'express';

import { z } from 'zod';

import { drizzle } from './db';

import {

monthly\_financial\_data,

doctor\_performance,

department\_performance,

} from '@shared/schema';

const r = Router();

const rangeSchema = z.object({

from: z.string().datetime(),

to: z.string().datetime(),

});

r.get('/analytics/employee/summary', async (req, res) => {

const { from, to } = rangeSchema.parse(req.query);

const rows = await drizzle

.select({ month: doctor\_performance.month, revenue: doctor\_performance.revenue, expense: doctor\_performance.expense, net: doctor\_performance.net })

.from(doctor\_performance)

.where(and(gte(doctor\_performance.month, from), lte(doctor\_performance.month, to)))

.groupBy(doctor\_performance.month)

.orderBy(doctor\_performance.month);

res.json(rows);

});

r.get('/analytics/employee/detail', async (req, res) => {

const qp = rangeSchema.extend({ employeeId: z.string() }).parse(req.query);

const rows = await drizzle

.select({ month: doctor\_performance.month, revenue: doctor\_performance.revenue, expense: doctor\_performance.expense, net: doctor\_performance.net, marginPct: sql\`net / NULLIF(revenue,0)\` })

.from(doctor\_performance)

.where(and(eq(doctor\_performance.employeeId, qp.employeeId), gte(doctor\_performance.month, qp.from), lte(doctor\_performance.month, qp.to)))

.orderBy(doctor\_performance.month);

res.json(rows);

});

// …repeat analogous endpoints for /business/summary and /business/detail

export default r;

_Mount_ this router in `server/routes.ts` under `/api`.

### 12.2 Front‑end Hooks

// client/src/hooks/useEmployeeAnalysis.ts

export function useEmployeeSummary(range) {

return useQuery(\['emp-summary', range\], () => api.get('/api/analytics/employee/summary', { params: range }).then(r => r.data), { staleTime: HALF\_DAY });

}

export function useEmployeeDetail(id, range) {

const enabled = !!id;

return useQuery(\['emp-detail', id, range\], () => api.get('/api/analytics/employee/detail', { params: { employeeId: id, ...range } }).then(r => r.data), { enabled, staleTime: HALF\_DAY });

}

_(identical_`useBusinessSummary`_/_`useBusinessDetail`_hooks live in_`useBusinessAnalysis.ts`_)._

### 12.3 Zustand Slice

// store/analysis-store.ts

const useAnalysisStore = create((set) => ({

range: defaultRange,

employeeId: null,

businessId: null,

setRange: (r) => set({ range: r }),

selectEmployee: (id) => set({ employeeId: id, businessId: null }),

selectBusiness: (id) => set({ businessId: id, employeeId: null }),

}));

export default useAnalysisStore;

### 12.4 Page Scaffolding (Employee‑Analysis)

// pages/employee-analysis.tsx

import { useEmployeeSummary, useEmployeeDetail } from '@/hooks/useEmployeeAnalysis';

import { MonthlyBarChart, ProfitabilityChart, AnalysisTable } from '@/components/analysis';

import useAnalysisStore from '@/store/analysis-store';

export default function EmployeeAnalysisPage() {

const { range, employeeId } = useAnalysisStore();

const { data: summary } = useEmployeeSummary(range);

const { data: detail } = useEmployeeDetail(employeeId, range);

const dataset = employeeId ? detail : summary;

return (

<MainLayout title="Employee Analysis">

<FiltersBar mode="employee" />

<KpiSection data={dataset} />

<MonthlyBarChart data={dataset} />

<ProfitabilityChart data={dataset} entitySelected={!!employeeId} />

<AnalysisTable data={dataset} />

</MainLayout>

);

}

_Business‑Analysis page swaps hook names + mode prop._

### 12.5 Component Usage

- `<FiltersBar mode="employee" />` – renders employee dropdown; dispatches `selectEmployee()`; re‑uses global date‑range selector.

- `<KpiSection>` – maps `dataset` to three KPI cards (rev, exp, net).

- `<MonthlyBarChart>` – colours match dashboard for visual continuity.

- `<ProfitabilityChart>` – picks `HorizontalBar` vs `Line` chart per PRD.

- `<AnalysisTable>` – exports CSV via existing `downloadCSV()` util.


### 12.6 Cache Invalidation

When new CSVs are uploaded, continue calling:

queryClient.invalidateQueries(\['emp-summary'\]);

queryClient.invalidateQueries(\['biz-summary'\]);

React‑Query cascades this to detail keys because they depend on summary → next navigation is always fresh.

* * *

**Cut‑and‑ship checklist**
1. Copy the route snippets into `analytics-routes.ts`, mount in Express.
2. Run `pnpm dev` and hit `/api/analytics/employee/summary` to verify JSON shape.
3. Generate hooks file and slice.
4. Add menu items in `components/layout/sidebar.tsx` for the two new pages.
5. Push → CI passes, deploy to Replit, ✅ done.